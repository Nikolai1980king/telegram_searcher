<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Searcher - –ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover {
            background: #218838;
        }
        
        .list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .tag .remove {
            cursor: pointer;
            font-weight: bold;
            padding: 0 5px;
        }
        
        .tag .remove:hover {
            color: #ffc107;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.idle {
            background: #e9ecef;
            color: #495057;
        }
        
        .status.running {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.stopped {
            background: #fff3cd;
            color: #856404;
        }
        
        .results {
            margin-top: 20px;
        }
        
        .result-item {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-item .info {
            flex: 1;
        }
        
        .result-item .info strong {
            color: #667eea;
        }
        
        .files-list {
            margin-top: 20px;
        }
        
        .file-item {
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Telegram Searcher</h1>
        
        <!-- –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ -->
        <div class="section">
            <h2>üìù –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</h2>
            <div class="input-group">
                <input type="text" id="keywordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞, –æ–±—â–µ–Ω–∏–µ, –¥—Ä—É–∑—å—è)">
                <button onclick="addKeyword()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <p style="margin-top: 5px; font-size: 12px; color: #666;">üí° –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</p>
            <div class="list" id="keywordsList"></div>
        </div>
        
        <!-- –ì–æ—Ä–æ–¥–∞ -->
        <div class="section">
            <h2>üèôÔ∏è –ì–æ—Ä–æ–¥–∞</h2>
            <div class="input-group">
                <input type="text" id="cityInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –°–ü–±, –ö–∞–∑–∞–Ω—å)">
                <button onclick="addCity()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <p style="margin-top: 5px; font-size: 12px; color: #666;">üí° –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</p>
            <div class="list" id="citiesList"></div>
        </div>
        
        <!-- –ó–∞–¥–µ—Ä–∂–∫–∞ -->
        <div class="section">
            <h2>‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏</h2>
            <div class="input-group">
                <input type="number" id="delayInput" value="5.0" min="0.5" max="60" step="0.5" placeholder="–°–µ–∫—É–Ω–¥—ã">
                <button onclick="setDelay()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <p style="margin-top: 10px; color: #666;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 5.0 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–º -->
        <div class="section">
            <h2>üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–º</h2>
            <div style="display: flex; gap: 10px;">
                <button id="startBtn" class="success" onclick="startSearch()" style="flex: 1; padding: 15px; font-size: 18px;">
                    –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫
                </button>
                <button id="stopBtn" class="danger" onclick="stopSearch()" style="flex: 1; padding: 15px; font-size: 18px;" disabled>
                    –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫
                </button>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="section">
            <h2>üìä –°—Ç–∞—Ç—É—Å</h2>
            <div id="status" class="status idle">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É</div>
            <div id="results" class="results"></div>
        </div>
        
        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ -->
        <div class="section">
            <h2>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏</h2>
            <p style="color: #666; margin-bottom: 15px;">
                –í—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –≥—Ä—É–ø–ø–∞–º–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            </p>
            
            <div style="margin-bottom: 15px;">
                <label for="groupsFileSelect" style="display: block; margin-bottom: 8px; font-weight: bold;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å –≥—Ä—É–ø–ø–∞–º–∏:
                </label>
                <select id="groupsFileSelect" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª --</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="checkGroupsBtn" class="success" onclick="startGroupsCheck()" style="flex: 1; padding: 15px; font-size: 16px;">
                    üîç –ù–∞—á–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –≥—Ä—É–ø–ø
                </button>
                <button id="stopCheckBtn" class="danger" onclick="stopGroupsCheck()" style="flex: 1; padding: 15px; font-size: 16px;" disabled>
                    ‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
                </button>
            </div>
            
            <div id="checkProgress" style="display: none; margin-top: 15px;">
                <div style="background: #f0f0f0; border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
                        <span id="checkProgressText">0 / 0</span>
                    </div>
                    <div style="background: #ddd; border-radius: 4px; height: 20px; overflow: hidden;">
                        <div id="checkProgressBar" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div id="checkStatus" style="color: #666; font-size: 14px;"></div>
            </div>
            
            <div id="checkResults" style="margin-top: 15px; display: none;">
                <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:</h3>
                <div id="checkResultsContent" style="background: #f9f9f9; padding: 15px; border-radius: 4px; margin-top: 10px;"></div>
            </div>
        </div>
        
        <!-- –û–±—Ä–∞–±–æ—Ç–∫–∞ pending –≥—Ä—É–ø–ø -->
        <div class="section">
            <h2>üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ pending –≥—Ä—É–ø–ø</h2>
            <p style="color: #666; margin-bottom: 15px;">
                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –≤—Å—Ç—É–ø–∏—Ç—å –≤ –≥—Ä—É–ø–ø—ã –∏–∑ —Å–ø–∏—Å–∫–∞ pending (–Ω–∞–∂–º–µ—Ç –∫–Ω–æ–ø–∫—É "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            </p>
            
            <div style="margin-bottom: 15px;">
                <label for="pendingFileSelect" style="display: block; margin-bottom: 8px; font-weight: bold;">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å pending –≥—Ä—É–ø–ø–∞–º–∏:
                </label>
                <select id="pendingFileSelect" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª --</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button id="processPendingBtn" class="success" onclick="startPendingProcessing()" style="flex: 1; padding: 15px; font-size: 16px;">
                    üîÑ –û–±—Ä–∞–±–æ—Ç–∞—Ç—å pending –≥—Ä—É–ø–ø—ã
                </button>
                <button id="stopPendingBtn" class="danger" onclick="stopPendingProcessing()" style="flex: 1; padding: 15px; font-size: 16px;" disabled>
                    ‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
                </button>
            </div>
            
            <div id="pendingProgress" style="display: none; margin-top: 15px;">
                <div style="background: #f0f0f0; border-radius: 4px; padding: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
                        <span id="pendingProgressText">0 / 0</span>
                    </div>
                    <div style="background: #ddd; border-radius: 4px; height: 20px; overflow: hidden;">
                        <div id="pendingProgressBar" style="background: #FF9800; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <div id="pendingStatus" style="color: #666; font-size: 14px;"></div>
            </div>
            
            <div id="pendingResults" style="margin-top: 15px; display: none;">
                <h3>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:</h3>
                <div id="pendingResultsContent" style="background: #f9f9f9; padding: 15px; border-radius: 4px; margin-top: 10px;"></div>
            </div>
        </div>
        
        <!-- –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö –≥—Ä—É–ø–ø -->
        <div class="section">
            <h2>üìã –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö –≥—Ä—É–ø–ø</h2>
            <p style="color: #666; margin-bottom: 15px;">
                –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã ready_groups –≤ –æ–¥–∏–Ω —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            </p>
            
            <button id="mergeReadyBtn" class="success" onclick="mergeReadyGroups()" style="width: 100%; padding: 15px; font-size: 16px; margin-bottom: 15px;">
                üìã –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ ready_groups –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª
            </button>
            
            <div id="mergeProgress" style="display: none; margin-top: 15px;">
                <div style="background: #f0f0f0; border-radius: 4px; padding: 10px;">
                    <div id="mergeStatus" style="color: #666; font-size: 14px;">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
                </div>
            </div>
            
            <div id="mergeResults" style="margin-top: 15px; display: none;">
                <div id="mergeResultsContent" style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin-top: 10px;"></div>
            </div>
        </div>
        
        <!-- –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="section">
            <h2>üìÅ –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
            <button onclick="loadFiles()" style="margin-bottom: 15px;">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div id="filesList" class="files-list"></div>
        </div>
    </div>
    
    <script>
        let keywords = {{ keywords|tojson }};
        let cities = {{ cities|tojson }};
        let delay = {{ delay }};
        let statusInterval = null;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = function() {
            updateKeywordsList();
            updateCitiesList();
            document.getElementById('delayInput').value = delay;
            loadFiles();
            checkStatus();
        };
        
        function checkStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    updateStatus(data);
                    if (data.status === 'running' || data.status === 'starting') {
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('startBtn').style.opacity = '0.5';
                        document.getElementById('stopBtn').disabled = false;
                        document.getElementById('stopBtn').style.opacity = '1';
                        startStatusPolling();
                    } else {
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('startBtn').style.opacity = '1';
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('stopBtn').style.opacity = '0.5';
                    }
                });
        }
        
        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const inputValue = input.value.trim();
            
            if (!inputValue) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞');
                return;
            }
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
            const keywordsToAdd = inputValue.split(',')
                .map(k => k.trim())
                .filter(k => k.length > 0);
            
            if (keywordsToAdd.length === 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –ø–æ –æ—á–µ—Ä–µ–¥–∏
            let lastResponse = null;
            let promises = keywordsToAdd.map(keyword => {
                return fetch('/api/add_keyword', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keyword: keyword})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        lastResponse = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                        return true;
                    } else {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å "${keyword}": ${data.message}`);
                        return false;
                    }
                });
            });
            
            Promise.all(promises).then(() => {
                if (lastResponse && lastResponse.success) {
                    keywords = lastResponse.keywords || [];
                    updateKeywordsList();
                }
                input.value = '';
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤');
            });
        }
        
        function removeKeyword(keyword) {
            console.log('–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞:', keyword);
            fetch('/api/remove_keyword', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({keyword: keyword})
            })
            .then(r => r.json())
            .then(data => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.success) {
                    keywords = data.keywords || [];
                    updateKeywordsList();
                    console.log('–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω:', keywords);
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞: ' + err);
            });
        }
        
        function updateKeywordsList() {
            const list = document.getElementById('keywordsList');
            if (keywords.length === 0) {
                list.innerHTML = '<p style="color: #999;">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                return;
            }
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            list.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ DOM –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            keywords.forEach(k => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${k} <span class="remove">√ó</span>`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
                const removeBtn = tag.querySelector('.remove');
                removeBtn.onclick = function(e) {
                    e.stopPropagation();
                    removeKeyword(k);
                };
                
                list.appendChild(tag);
            });
        }
        
        function addCity() {
            const input = document.getElementById('cityInput');
            const inputValue = input.value.trim();
            
            if (!inputValue) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤');
                return;
            }
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
            const citiesToAdd = inputValue.split(',')
                .map(c => c.trim())
                .filter(c => c.length > 0);
            
            if (citiesToAdd.length === 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥–æ—Ä–æ–¥');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –≥–æ—Ä–æ–¥ –ø–æ –æ—á–µ—Ä–µ–¥–∏
            let lastResponse = null;
            let promises = citiesToAdd.map(city => {
                return fetch('/api/add_city', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({city: city})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        lastResponse = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                        return true;
                    } else {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å "${city}": ${data.message}`);
                        return false;
                    }
                });
            });
            
            Promise.all(promises).then(() => {
                if (lastResponse && lastResponse.success) {
                    cities = lastResponse.cities || [];
                    updateCitiesList();
                }
                input.value = '';
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–æ–≤:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–æ–≤');
            });
        }
        
        function removeCity(city) {
            console.log('–£–¥–∞–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:', city);
            fetch('/api/remove_city', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({city: city})
            })
            .then(r => r.json())
            .then(data => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.success) {
                    cities = data.cities || [];
                    updateCitiesList();
                    console.log('–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω:', cities);
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–∞: ' + err);
            });
        }
        
        function updateCitiesList() {
            const list = document.getElementById('citiesList');
            if (cities.length === 0) {
                list.innerHTML = '<p style="color: #999;">–ì–æ—Ä–æ–¥–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                return;
            }
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            list.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ DOM –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            cities.forEach(c => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${c} <span class="remove">√ó</span>`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
                const removeBtn = tag.querySelector('.remove');
                removeBtn.onclick = function(e) {
                    e.stopPropagation();
                    removeCity(c);
                };
                
                list.appendChild(tag);
            });
        }
        
        function setDelay() {
            const input = document.getElementById('delayInput');
            delay = parseFloat(input.value);
            
            fetch('/api/set_delay', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({delay: delay})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('–ó–∞–¥–µ—Ä–∂–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ' + delay + ' —Å–µ–∫—É–Ω–¥');
                }
            });
        }
        
        function startSearch() {
            console.log('üîç –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
            if (!keywords || keywords.length === 0) {
                alert('‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–æ–∏—Å–∫–∞!');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            startBtn.disabled = true;
            startBtn.textContent = '–ó–∞–ø—É—Å–∫...';
            
            fetch('/api/start_search', {method: 'POST'})
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP error! status: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                    if (data.success) {
                        startBtn.disabled = true;
                        startBtn.style.opacity = '0.5';
                        startBtn.textContent = '–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫';
                        stopBtn.disabled = false;
                        stopBtn.style.opacity = '1';
                        startStatusPolling();
                        console.log('‚úÖ –ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω');
                    } else {
                        startBtn.disabled = false;
                        alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ–∏—Å–∫–∞:', data);
                    }
                })
                .catch(err => {
                    startBtn.disabled = false;
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ:', err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–∏—Å–∫–∞: ' + err.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
                });
        }
        
        function stopSearch() {
            console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–∏—Å–∫–∞...');
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫? –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.')) {
                const stopBtn = document.getElementById('stopBtn');
                stopBtn.disabled = true;
                stopBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';
                
                fetch('/api/stop_search', {method: 'POST'})
                    .then(r => {
                        if (!r.ok) {
                            throw new Error(`HTTP error! status: ${r.status}`);
                        }
                        return r.json();
                    })
                    .then(data => {
                        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                        if (data.success) {
                            stopBtn.disabled = true;
                            stopBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';
                            console.log('‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
                        } else {
                            stopBtn.disabled = false;
                            stopBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫';
                            alert(data.message || '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
                            console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', data);
                        }
                    })
                    .catch(err => {
                        stopBtn.disabled = false;
                        stopBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫';
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', err);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–∏—Å–∫–∞: ' + err.message);
                    });
            }
        }
        
        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            
            statusInterval = setInterval(() => {
                fetch('/api/status')
                    .then(r => r.json())
                    .then(data => {
                        updateStatus(data);
                        
                        if (data.status === 'completed' || data.status === 'error' || data.status === 'interrupted' || data.status === 'stopped') {
                            clearInterval(statusInterval);
                            document.getElementById('startBtn').disabled = false;
                            document.getElementById('startBtn').style.opacity = '1';
                            document.getElementById('stopBtn').disabled = true;
                            document.getElementById('stopBtn').style.opacity = '0.5';
                            document.getElementById('stopBtn').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫';
                            loadFiles();
                        }
                    });
            }, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        }
        
        function updateStatus(data) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + data.status;
            statusDiv.textContent = data.message || '–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É';
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
            if (data.status === 'running' || data.status === 'starting') {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').style.opacity = '0.5';
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('stopBtn').style.opacity = '1';
            } else {
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').style.opacity = '1';
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('stopBtn').style.opacity = '0.5';
            }
            
            const resultsDiv = document.getElementById('results');
            if (data.results) {
                resultsDiv.innerHTML = `
                    <div class="result-item">
                        <div class="info">
                            <strong>–ì—Ä—É–ø–ø—ã:</strong> ${data.results.groups_count} –Ω–∞–π–¥–µ–Ω–æ
                        </div>
                        <button onclick="downloadFile('${data.results.groups_file.split('/').pop()}')">–°–∫–∞—á–∞—Ç—å</button>
                    </div>
                    <div class="result-item">
                        <div class="info">
                            <strong>–ö–∞–Ω–∞–ª—ã:</strong> ${data.results.channels_count} –Ω–∞–π–¥–µ–Ω–æ
                        </div>
                        <button onclick="downloadFile('${data.results.channels_file.split('/').pop()}')">–°–∫–∞—á–∞—Ç—å</button>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = '';
            }
        }
        
        function downloadFile(filename) {
            window.location.href = '/api/download/' + filename;
        }
        
        function loadFiles() {
            fetch('/api/get_files')
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('filesList');
                    if (data.files.length === 0) {
                        list.innerHTML = '<p>–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                        return;
                    }
                    
                    list.innerHTML = data.files.map(f => `
                        <div class="file-item">
                            <div>
                                <strong>${f.name}</strong><br>
                                <small>${f.modified} (${(f.size / 1024).toFixed(2)} KB)</small>
                            </div>
                            <button onclick="downloadFile('${f.name}')">–°–∫–∞—á–∞—Ç—å</button>
                        </div>
                    `).join('');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø
                    const select = document.getElementById('groupsFileSelect');
                    const groupsFiles = data.files.filter(f => f.name.includes('groups') && f.name.endsWith('.xlsx') && !f.name.includes('pending') && !f.name.includes('ready'));
                    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª --</option>' + 
                        groupsFiles.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ pending –≥—Ä—É–ø–ø
                    const pendingSelect = document.getElementById('pendingFileSelect');
                    const pendingFiles = data.files.filter(f => f.name.includes('pending') && f.name.endsWith('.xlsx'));
                    pendingSelect.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª --</option>' + 
                        pendingFiles.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
                });
        }
        
        let checkGroupsInterval = null;
        let checkStopFlag = false;
        
        function startGroupsCheck() {
            const filename = document.getElementById('groupsFileSelect').value;
            if (!filename) {
                alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å –≥—Ä—É–ø–ø–∞–º–∏!');
                return;
            }
            
            if (!filename.includes('groups')) {
                alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å –≥—Ä—É–ø–ø–∞–º–∏ (–¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å "groups" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏)!');
                return;
            }
            
            checkStopFlag = false;
            document.getElementById('checkGroupsBtn').disabled = true;
            document.getElementById('stopCheckBtn').disabled = false;
            document.getElementById('checkProgress').style.display = 'block';
            document.getElementById('checkResults').style.display = 'none';
            
            fetch('/api/check_groups', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename: filename})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    startCheckStatusPolling();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    resetCheckButtons();
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' + err.message);
                resetCheckButtons();
            });
        }
        
        function stopGroupsCheck() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É?')) {
                checkStopFlag = true;
                fetch('/api/stop_check_groups', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('checkStatus').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏...';
                        }
                    });
            }
        }
        
        function resetCheckButtons() {
            document.getElementById('checkGroupsBtn').disabled = false;
            document.getElementById('stopCheckBtn').disabled = true;
        }
        
        function startCheckStatusPolling() {
            if (checkGroupsInterval) clearInterval(checkGroupsInterval);
            
            checkGroupsInterval = setInterval(() => {
                if (checkStopFlag) {
                    clearInterval(checkGroupsInterval);
                    return;
                }
                
                fetch('/api/check_groups_status')
                    .then(r => r.json())
                    .then(data => {
                        updateCheckProgress(data);
                        
                        if (data.status === 'completed' || data.status === 'error' || data.status === 'stopped') {
                            clearInterval(checkGroupsInterval);
                            resetCheckButtons();
                            if (data.status === 'completed') {
                                document.getElementById('checkResults').style.display = 'block';
                                
                                let resultsHTML = `
                                    <p><strong>‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</strong></p>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                        <div style="background: #e8f5e9; padding: 15px; border-radius: 4px;">
                                            <h4 style="margin-top: 0; color: #2e7d32;">‚úÖ –ì–æ—Ç–æ–≤—ã–µ –∫ —Ä–∞—Å—Å—ã–ª–∫–µ</h4>
                                            <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">${data.ready_count || 0}</p>
                                `;
                                
                                if (data.ready_file) {
                                    resultsHTML += `
                                            <button onclick="downloadFile('${data.ready_file}')" class="success" style="width: 100%; padding: 10px; margin-top: 10px;">
                                                üì• –°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã
                                            </button>
                                    `;
                                } else {
                                    resultsHTML += `<p style="color: #999; font-size: 12px;">–ù–µ—Ç –≥–æ—Ç–æ–≤—ã—Ö –≥—Ä—É–ø–ø</p>`;
                                }
                                
                                resultsHTML += `
                                        </div>
                                        <div style="background: #fff3e0; padding: 15px; border-radius: 4px;">
                                            <h4 style="margin-top: 0; color: #e65100;">‚è≥ –¢—Ä–µ–±—É—é—Ç –¥–µ–π—Å—Ç–≤–∏–π</h4>
                                            <p style="font-size: 24px; font-weight: bold; color: #e65100; margin: 10px 0;">${(data.pending_count || 0) + (data.unavailable_count || 0)}</p>
                                `;
                                
                                if (data.pending_file) {
                                    resultsHTML += `
                                            <button onclick="downloadFile('${data.pending_file}')" class="danger" style="width: 100%; padding: 10px; margin-top: 10px; background: #ff9800;">
                                                üì• –°–∫–∞—á–∞—Ç—å –≥—Ä—É–ø–ø—ã –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
                                            </button>
                                    `;
                                } else {
                                    resultsHTML += `<p style="color: #999; font-size: 12px;">–ù–µ—Ç –≥—Ä—É–ø–ø –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ</p>`;
                                }
                                
                                resultsHTML += `
                                        </div>
                                    </div>
                                `;
                                
                                document.getElementById('checkResultsContent').innerHTML = resultsHTML;
                                loadFiles();
                            }
                        }
                    });
            }, 2000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        }
        
        function updateCheckProgress(data) {
            const progressBar = document.getElementById('checkProgressBar');
            const progressText = document.getElementById('checkProgressText');
            const statusDiv = document.getElementById('checkStatus');
            
            if (data.total && data.current !== undefined) {
                const percent = Math.round((data.current / data.total) * 100);
                progressBar.style.width = percent + '%';
                progressText.textContent = `${data.current} / ${data.total} (${percent}%)`;
            }
            
            if (data.message) {
                statusDiv.textContent = data.message;
            }
            
            if (data.current_group) {
                statusDiv.textContent = `–ü—Ä–æ–≤–µ—Ä—è—é: ${data.current_group}`;
            }
        }
        
        let pendingInterval = null;
        let pendingStopFlag = false;
        
        function startPendingProcessing() {
            const filename = document.getElementById('pendingFileSelect').value;
            if (!filename) {
                alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å pending –≥—Ä—É–ø–ø–∞–º–∏!');
                return;
            }
            
            if (!filename.includes('pending')) {
                alert('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —Å pending –≥—Ä—É–ø–ø–∞–º–∏ (–¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å "pending" –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏)!');
                return;
            }
            
            pendingStopFlag = false;
            document.getElementById('processPendingBtn').disabled = true;
            document.getElementById('stopPendingBtn').disabled = false;
            document.getElementById('pendingProgress').style.display = 'block';
            document.getElementById('pendingResults').style.display = 'none';
            
            fetch('/api/process_pending_groups', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename: filename})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    startPendingStatusPolling();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    resetPendingButtons();
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ' + err.message);
                resetPendingButtons();
            });
        }
        
        function stopPendingProcessing() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É?')) {
                pendingStopFlag = true;
                fetch('/api/stop_process_pending', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('pendingStatus').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏...';
                        }
                    });
            }
        }
        
        function resetPendingButtons() {
            document.getElementById('processPendingBtn').disabled = false;
            document.getElementById('stopPendingBtn').disabled = true;
        }
        
        function startPendingStatusPolling() {
            if (pendingInterval) clearInterval(pendingInterval);
            
            pendingInterval = setInterval(() => {
                if (pendingStopFlag) {
                    clearInterval(pendingInterval);
                    return;
                }
                
                fetch('/api/process_pending_status')
                    .then(r => r.json())
                    .then(data => {
                        updatePendingProgress(data);
                        
                        if (data.status === 'completed' || data.status === 'error' || data.status === 'stopped') {
                            clearInterval(pendingInterval);
                            resetPendingButtons();
                            if (data.status === 'completed') {
                                document.getElementById('pendingResults').style.display = 'block';
                                
                                let resultsHTML = `
                                    <p><strong>‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</strong></p>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                                        <div style="background: #e8f5e9; padding: 15px; border-radius: 4px;">
                                            <h4 style="margin-top: 0; color: #2e7d32;">‚úÖ –ù–æ–≤—ã–µ –≥–æ—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã</h4>
                                            <p style="font-size: 24px; font-weight: bold; color: #2e7d32; margin: 10px 0;">${data.new_ready_count || 0}</p>
                                `;
                                
                                if (data.new_ready_file) {
                                    resultsHTML += `
                                            <button onclick="downloadFile('${data.new_ready_file}')" class="success" style="width: 100%; padding: 10px; margin-top: 10px;">
                                                üì• –°–∫–∞—á–∞—Ç—å –Ω–æ–≤—ã–µ –≥–æ—Ç–æ–≤—ã–µ –≥—Ä—É–ø–ø—ã
                                            </button>
                                    `;
                                } else {
                                    resultsHTML += `<p style="color: #999; font-size: 12px;">–ù–µ—Ç –Ω–æ–≤—ã—Ö –≥–æ—Ç–æ–≤—ã—Ö –≥—Ä—É–ø–ø</p>`;
                                }
                                
                                resultsHTML += `
                                        </div>
                                        <div style="background: #fff3e0; padding: 15px; border-radius: 4px;">
                                            <h4 style="margin-top: 0; color: #e65100;">‚è≥ –í—Å–µ –µ—â–µ pending</h4>
                                            <p style="font-size: 24px; font-weight: bold; color: #e65100; margin: 10px 0;">${data.still_pending_count || 0}</p>
                                `;
                                
                                if (data.updated_pending_file) {
                                    resultsHTML += `
                                            <button onclick="downloadFile('${data.updated_pending_file}')" class="danger" style="width: 100%; padding: 10px; margin-top: 10px; background: #ff9800;">
                                                üì• –°–∫–∞—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π pending
                                            </button>
                                    `;
                                } else {
                                    resultsHTML += `<p style="color: #999; font-size: 12px;">–ù–µ—Ç pending –≥—Ä—É–ø–ø</p>`;
                                }
                                
                                resultsHTML += `
                                        </div>
                                    </div>
                                `;
                                
                                document.getElementById('pendingResultsContent').innerHTML = resultsHTML;
                                loadFiles();
                            }
                        }
                    });
            }, 2000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
        }
        
        function updatePendingProgress(data) {
            const progressBar = document.getElementById('pendingProgressBar');
            const progressText = document.getElementById('pendingProgressText');
            const statusDiv = document.getElementById('pendingStatus');
            
            if (data.total && data.current !== undefined) {
                const percent = Math.round((data.current / data.total) * 100);
                progressBar.style.width = percent + '%';
                progressText.textContent = `${data.current} / ${data.total} (${percent}%)`;
            }
            
            if (data.message) {
                statusDiv.textContent = data.message;
            }
            
            if (data.current_group) {
                statusDiv.textContent = `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é: ${data.current_group}`;
            }
        }
        
        function mergeReadyGroups() {
            console.log('üìã –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö ready_groups —Ñ–∞–π–ª–æ–≤...');
            
            const btn = document.getElementById('mergeReadyBtn');
            const progressDiv = document.getElementById('mergeProgress');
            const resultsDiv = document.getElementById('mergeResults');
            
            btn.disabled = true;
            btn.textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
            progressDiv.style.display = 'block';
            resultsDiv.style.display = 'none';
            document.getElementById('mergeStatus').textContent = '–ü–æ–∏—Å–∫ –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ ready_groups...';
            
            fetch('/api/merge_ready_groups', {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.textContent = 'üìã –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ ready_groups –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª';
                progressDiv.style.display = 'none';
                
                if (data.success) {
                    resultsDiv.style.display = 'block';
                    document.getElementById('mergeResultsContent').innerHTML = `
                        <p><strong>‚úÖ –§–∞–π–ª—ã —É—Å–ø–µ—à–Ω–æ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã!</strong></p>
                        <p>–û–±—ä–µ–¥–∏–Ω–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: <strong>${data.files_count || 0}</strong></p>
                        <p>–í—Å–µ–≥–æ –≥—Ä—É–ø–ø –≤ —Ñ–∞–π–ª–µ: <strong>${data.total_groups || 0}</strong></p>
                        <p style="margin-top: 15px;">
                            <button onclick="downloadFile('${data.result_file}')" class="success" style="padding: 15px 30px; font-size: 16px;">
                                üì• –°–∫–∞—á–∞—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: ${data.result_file}
                            </button>
                        </p>
                    `;
                    loadFiles();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    console.error('–û—à–∏–±–∫–∞ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:', data);
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.textContent = 'üìã –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ ready_groups –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª';
                progressDiv.style.display = 'none';
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤: ' + err.message);
            });
        }
        
        // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('keywordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addKeyword();
        });
        
        document.getElementById('cityInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCity();
        });
    </script>
</body>
</html>

