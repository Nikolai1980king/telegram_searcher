<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Searcher - –ü–æ–∏—Å–∫ –≥—Ä—É–ø–ø –∏ –∫–∞–Ω–∞–ª–æ–≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button.danger {
            background: #dc3545;
        }
        
        button.danger:hover {
            background: #c82333;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.success:hover {
            background: #218838;
        }
        
        .list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .tag .remove {
            cursor: pointer;
            font-weight: bold;
            padding: 0 5px;
        }
        
        .tag .remove:hover {
            color: #ffc107;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.idle {
            background: #e9ecef;
            color: #495057;
        }
        
        .status.running {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.completed {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.stopped {
            background: #fff3cd;
            color: #856404;
        }
        
        .results {
            margin-top: 20px;
        }
        
        .result-item {
            padding: 15px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-item .info {
            flex: 1;
        }
        
        .result-item .info strong {
            color: #667eea;
        }
        
        .files-list {
            margin-top: 20px;
        }
        
        .file-item {
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Telegram Searcher</h1>
        
        <!-- –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ -->
        <div class="section">
            <h2>üìù –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞</h2>
            <div class="input-group">
                <input type="text" id="keywordInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞, –æ–±—â–µ–Ω–∏–µ, –¥—Ä—É–∑—å—è)">
                <button onclick="addKeyword()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <p style="margin-top: 5px; font-size: 12px; color: #666;">üí° –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</p>
            <div class="list" id="keywordsList"></div>
        </div>
        
        <!-- –ì–æ—Ä–æ–¥–∞ -->
        <div class="section">
            <h2>üèôÔ∏è –ì–æ—Ä–æ–¥–∞</h2>
            <div class="input-group">
                <input type="text" id="cityInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, –°–ü–±, –ö–∞–∑–∞–Ω—å)">
                <button onclick="addCity()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <p style="margin-top: 5px; font-size: 12px; color: #666;">üí° –ú–æ–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</p>
            <div class="list" id="citiesList"></div>
        </div>
        
        <!-- –ó–∞–¥–µ—Ä–∂–∫–∞ -->
        <div class="section">
            <h2>‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏</h2>
            <div class="input-group">
                <input type="number" id="delayInput" value="5.0" min="0.5" max="60" step="0.5" placeholder="–°–µ–∫—É–Ω–¥—ã">
                <button onclick="setDelay()">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <p style="margin-top: 10px; color: #666;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 5.0 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</p>
        </div>
        
        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–º -->
        <div class="section">
            <h2>üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–º</h2>
            <div style="display: flex; gap: 10px;">
                <button id="startBtn" class="success" onclick="startSearch()" style="flex: 1; padding: 15px; font-size: 18px;">
                    –ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫
                </button>
                <button id="stopBtn" class="danger" onclick="stopSearch()" style="flex: 1; padding: 15px; font-size: 18px;" disabled>
                    –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫
                </button>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å -->
        <div class="section">
            <h2>üìä –°—Ç–∞—Ç—É—Å</h2>
            <div id="status" class="status idle">–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É</div>
            <div id="results" class="results"></div>
        </div>
        
        <!-- –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="section">
            <h2>üìÅ –§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</h2>
            <button onclick="loadFiles()" style="margin-bottom: 15px;">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div id="filesList" class="files-list"></div>
        </div>
    </div>
    
    <script>
        let keywords = {{ keywords|tojson }};
        let cities = {{ cities|tojson }};
        let delay = {{ delay }};
        let statusInterval = null;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = function() {
            updateKeywordsList();
            updateCitiesList();
            document.getElementById('delayInput').value = delay;
            loadFiles();
            checkStatus();
        };
        
        function checkStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    updateStatus(data);
                    if (data.status === 'running' || data.status === 'starting') {
                        document.getElementById('startBtn').disabled = true;
                        document.getElementById('startBtn').style.opacity = '0.5';
                        document.getElementById('stopBtn').disabled = false;
                        document.getElementById('stopBtn').style.opacity = '1';
                        startStatusPolling();
                    } else {
                        document.getElementById('startBtn').disabled = false;
                        document.getElementById('startBtn').style.opacity = '1';
                        document.getElementById('stopBtn').disabled = true;
                        document.getElementById('stopBtn').style.opacity = '0.5';
                    }
                });
        }
        
        function addKeyword() {
            const input = document.getElementById('keywordInput');
            const inputValue = input.value.trim();
            
            if (!inputValue) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞');
                return;
            }
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
            const keywordsToAdd = inputValue.split(',')
                .map(k => k.trim())
                .filter(k => k.length > 0);
            
            if (keywordsToAdd.length === 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –ø–æ –æ—á–µ—Ä–µ–¥–∏
            let lastResponse = null;
            let promises = keywordsToAdd.map(keyword => {
                return fetch('/api/add_keyword', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keyword: keyword})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        lastResponse = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                        return true;
                    } else {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å "${keyword}": ${data.message}`);
                        return false;
                    }
                });
            });
            
            Promise.all(promises).then(() => {
                if (lastResponse && lastResponse.success) {
                    keywords = lastResponse.keywords || [];
                    updateKeywordsList();
                }
                input.value = '';
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤');
            });
        }
        
        function removeKeyword(keyword) {
            console.log('–£–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞:', keyword);
            fetch('/api/remove_keyword', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({keyword: keyword})
            })
            .then(r => r.json())
            .then(data => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.success) {
                    keywords = data.keywords || [];
                    updateKeywordsList();
                    console.log('–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω:', keywords);
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞: ' + err);
            });
        }
        
        function updateKeywordsList() {
            const list = document.getElementById('keywordsList');
            if (keywords.length === 0) {
                list.innerHTML = '<p style="color: #999;">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                return;
            }
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            list.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ DOM –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            keywords.forEach(k => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${k} <span class="remove">√ó</span>`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
                const removeBtn = tag.querySelector('.remove');
                removeBtn.onclick = function(e) {
                    e.stopPropagation();
                    removeKeyword(k);
                };
                
                list.appendChild(tag);
            });
        }
        
        function addCity() {
            const input = document.getElementById('cityInput');
            const inputValue = input.value.trim();
            
            if (!inputValue) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤');
                return;
            }
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ –∑–∞–ø—è—Ç–æ–π –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
            const citiesToAdd = inputValue.split(',')
                .map(c => c.trim())
                .filter(c => c.length > 0);
            
            if (citiesToAdd.length === 0) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≥–æ—Ä–æ–¥');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –≥–æ—Ä–æ–¥ –ø–æ –æ—á–µ—Ä–µ–¥–∏
            let lastResponse = null;
            let promises = citiesToAdd.map(city => {
                return fetch('/api/add_city', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({city: city})
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        lastResponse = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                        return true;
                    } else {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å "${city}": ${data.message}`);
                        return false;
                    }
                });
            });
            
            Promise.all(promises).then(() => {
                if (lastResponse && lastResponse.success) {
                    cities = lastResponse.cities || [];
                    updateCitiesList();
                }
                input.value = '';
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–æ–≤:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–æ–≤');
            });
        }
        
        function removeCity(city) {
            console.log('–£–¥–∞–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞:', city);
            fetch('/api/remove_city', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({city: city})
            })
            .then(r => r.json())
            .then(data => {
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                if (data.success) {
                    cities = data.cities || [];
                    updateCitiesList();
                    console.log('–°–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω:', cities);
                } else {
                    alert(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–∞: ' + err);
            });
        }
        
        function updateCitiesList() {
            const list = document.getElementById('citiesList');
            if (cities.length === 0) {
                list.innerHTML = '<p style="color: #999;">–ì–æ—Ä–æ–¥–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                return;
            }
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            list.innerHTML = '';
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ DOM –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            cities.forEach(c => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${c} <span class="remove">√ó</span>`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫—Ä–µ—Å—Ç–∏–∫
                const removeBtn = tag.querySelector('.remove');
                removeBtn.onclick = function(e) {
                    e.stopPropagation();
                    removeCity(c);
                };
                
                list.appendChild(tag);
            });
        }
        
        function setDelay() {
            const input = document.getElementById('delayInput');
            delay = parseFloat(input.value);
            
            fetch('/api/set_delay', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({delay: delay})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('–ó–∞–¥–µ—Ä–∂–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ' + delay + ' —Å–µ–∫—É–Ω–¥');
                }
            });
        }
        
        function startSearch() {
            console.log('üîç –ó–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
            if (!keywords || keywords.length === 0) {
                alert('‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–æ–∏—Å–∫–∞!');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            startBtn.disabled = true;
            startBtn.textContent = '–ó–∞–ø—É—Å–∫...';
            
            fetch('/api/start_search', {method: 'POST'})
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP error! status: ${r.status}`);
                    }
                    return r.json();
                })
                .then(data => {
                    console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                    if (data.success) {
                        startBtn.disabled = true;
                        startBtn.style.opacity = '0.5';
                        startBtn.textContent = '–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫';
                        stopBtn.disabled = false;
                        stopBtn.style.opacity = '1';
                        startStatusPolling();
                        console.log('‚úÖ –ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω');
                    } else {
                        startBtn.disabled = false;
                        alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–æ–∏—Å–∫–∞:', data);
                    }
                })
                .catch(err => {
                    startBtn.disabled = false;
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ:', err);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ–∏—Å–∫–∞: ' + err.message + '\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
                });
        }
        
        function stopSearch() {
            console.log('üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–∏—Å–∫–∞...');
            
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫? –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.')) {
                const stopBtn = document.getElementById('stopBtn');
                stopBtn.disabled = true;
                stopBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';
                
                fetch('/api/stop_search', {method: 'POST'})
                    .then(r => {
                        if (!r.ok) {
                            throw new Error(`HTTP error! status: ${r.status}`);
                        }
                        return r.json();
                    })
                    .then(data => {
                        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                        if (data.success) {
                            stopBtn.disabled = true;
                            stopBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∫–∞...';
                            console.log('‚úÖ –ö–æ–º–∞–Ω–¥–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
                        } else {
                            stopBtn.disabled = false;
                            stopBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫';
                            alert(data.message || '–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏');
                            console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', data);
                        }
                    })
                    .catch(err => {
                        stopBtn.disabled = false;
                        stopBtn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫';
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:', err);
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ–∏—Å–∫–∞: ' + err.message);
                    });
            }
        }
        
        function startStatusPolling() {
            if (statusInterval) clearInterval(statusInterval);
            
            statusInterval = setInterval(() => {
                fetch('/api/status')
                    .then(r => r.json())
                    .then(data => {
                        updateStatus(data);
                        
                        if (data.status === 'completed' || data.status === 'error' || data.status === 'interrupted' || data.status === 'stopped') {
                            clearInterval(statusInterval);
                            document.getElementById('startBtn').disabled = false;
                            document.getElementById('startBtn').style.opacity = '1';
                            document.getElementById('stopBtn').disabled = true;
                            document.getElementById('stopBtn').style.opacity = '0.5';
                            document.getElementById('stopBtn').textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–∏—Å–∫';
                            loadFiles();
                        }
                    });
            }, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        }
        
        function updateStatus(data) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = 'status ' + data.status;
            statusDiv.textContent = data.message || '–ì–æ—Ç–æ–≤ –∫ –∑–∞–ø—É—Å–∫—É';
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞
            if (data.status === 'running' || data.status === 'starting') {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').style.opacity = '0.5';
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('stopBtn').style.opacity = '1';
            } else {
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').style.opacity = '1';
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('stopBtn').style.opacity = '0.5';
            }
            
            const resultsDiv = document.getElementById('results');
            if (data.results) {
                resultsDiv.innerHTML = `
                    <div class="result-item">
                        <div class="info">
                            <strong>–ì—Ä—É–ø–ø—ã:</strong> ${data.results.groups_count} –Ω–∞–π–¥–µ–Ω–æ
                        </div>
                        <button onclick="downloadFile('${data.results.groups_file.split('/').pop()}')">–°–∫–∞—á–∞—Ç—å</button>
                    </div>
                    <div class="result-item">
                        <div class="info">
                            <strong>–ö–∞–Ω–∞–ª—ã:</strong> ${data.results.channels_count} –Ω–∞–π–¥–µ–Ω–æ
                        </div>
                        <button onclick="downloadFile('${data.results.channels_file.split('/').pop()}')">–°–∫–∞—á–∞—Ç—å</button>
                    </div>
                `;
            } else {
                resultsDiv.innerHTML = '';
            }
        }
        
        function downloadFile(filename) {
            window.location.href = '/api/download/' + filename;
        }
        
        function loadFiles() {
            fetch('/api/get_files')
                .then(r => r.json())
                .then(data => {
                    const list = document.getElementById('filesList');
                    if (data.files.length === 0) {
                        list.innerHTML = '<p>–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                        return;
                    }
                    
                    list.innerHTML = data.files.map(f => `
                        <div class="file-item">
                            <div>
                                <strong>${f.name}</strong><br>
                                <small>${f.modified} (${(f.size / 1024).toFixed(2)} KB)</small>
                            </div>
                            <button onclick="downloadFile('${f.name}')">–°–∫–∞—á–∞—Ç—å</button>
                        </div>
                    `).join('');
                });
        }
        
        // Enter –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('keywordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addKeyword();
        });
        
        document.getElementById('cityInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCity();
        });
    </script>
</body>
</html>

